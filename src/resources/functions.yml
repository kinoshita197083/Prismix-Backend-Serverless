# Initial Check Function - file corruptions check, queue image for processing
enqueueImage:
  handler: src/handlers/enqueueImage.handler
  events:
    - s3:
        bucket: ${self:custom.bucketName}
        event: s3:ObjectCreated:*
        existing: true
  environment:
    BUCKET_NAME: ${self:custom.bucketName}
    SNS_TOPIC_ARN: 
      Ref: ImageProcessingTopic
  role: EnqueueImageFunctionRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

# Worker Function - main processing functions
worker:
  handler: src/handlers/worker.handler
  memorySize: 2048
  events:
    - sqs:
        arn:
          Fn::GetAtt: [EligibleImageQueue, Arn]
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    DEAD_LETTER_QUEUE_URL:
      Ref: ImageDeadLetterQueue
  role: WorkerFunctionRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:testSharp:1
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

# Dead Letter Queue Processor
deadLetterQueueProcessor:
  handler: src/handlers/deadLetterQueueProcessor.handler
  events:
    - sqs:
        arn:
          Fn::GetAtt: [ImageDeadLetterQueue, Arn]
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    DEAD_LETTER_QUEUE_URL:
      Ref: ImageDeadLetterQueue
    ORIGINAL_QUEUE_URL:
      Ref: EligibleImageQueue
  role: DeadLetterQueueProcessorRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

# DynamoDB Stream - Job Completion Checker
jobCompletionChecker:
  handler: src/handlers/jobCompletionChecker.handler
  events:
    - stream:
        type: dynamodb
        arn:
          Fn::GetAtt: [JobProgressTable, StreamArn]
  environment:
    JOB_PROGRESS_TABLE: ${self:provider.environment.JOB_PROGRESS_TABLE}
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    JOB_COMPLETION_TOPIC_ARN: 
      Ref: JobCompletionTopic
    # JOB_COMPLETION_TOPIC_ARN: 
    #   Ref: JobCompletionTopic
    # JOB_COMPLETION_QUEUE_URL:
    #   Ref: JobCompletionQueue
  role: JobCompletionCheckerRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

# taskStreamProcessor:
taskStreamProcessor:
  handler: src/handlers/taskStreamProcessor.handler
  events:
    - stream:
        type: dynamodb
        arn:
          Fn::GetAtt: [TasksTable, StreamArn]
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
  role: TaskStreamProcessorRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

deliveryProcessor:
  handler: src/handlers/deliveryProcessor.handler
  events:
    - sqs:
        arn:
          Fn::GetAtt: [DeliveryQueue, Arn]
  environment:
    DELIVERY_QUEUE_URL:
      Ref: DeliveryQueue
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    BUCKET_NAME: ${self:custom.bucketName}
  role: DeliveryProcessorRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1
    - arn:aws:lambda:us-east-1:980352750282:layer:jszip-layer:1

notificationProcessor:
  handler: src/handlers/notificationProcessor.handler
  events:
    - sqs:
        arn:
          Fn::GetAtt: [NotificationQueue, Arn]
  environment:
    NOTIFICATION_QUEUE_URL:
      Ref: NotificationQueue
  role: NotificationProcessorRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1
