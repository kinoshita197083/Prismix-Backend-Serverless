# Initial Check Function - file corruptions check, queue image for processing
enqueueImage:
  handler: src/handlers/enqueueImage.handler
  events:
    - s3:
        bucket: ${self:custom.bucketName}
        event: s3:ObjectCreated:*
        existing: true
  environment:
    BUCKET_NAME: ${self:custom.bucketName}
    SNS_TOPIC_ARN: 
      Ref: ImageProcessingTopic
  role: EnqueueImageFunctionRole

# Worker Function - main processing functions
worker:
  handler: src/handlers/worker.handler
  events:
    - sqs:
        arn:
          Fn::GetAtt: [EligibleImageQueue, Arn]
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    DEAD_LETTER_QUEUE_URL:
      Ref: ImageDeadLetterQueue
  role: WorkerFunctionRole

# Dead Letter Queue Processor
deadLetterQueueProcessor:
  handler: src/handlers/deadLetterQueueProcessor.handler
  events:
    - sqs:
        arn:
          Fn::GetAtt: [ImageDeadLetterQueue, Arn]
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
  role: DeadLetterQueueProcessorRole

# DynamoDB Stream - Job Completion Checker
# taskStreamProcessor:
taskStreamProcessor:
  handler: src/handlers/taskStreamProcessor.handler
  events:
    - stream:
        type: dynamodb
        arn:
          Fn::GetAtt: [TasksTable, StreamArn]
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
  role: TaskStreamProcessorRole