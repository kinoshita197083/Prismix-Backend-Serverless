# Initial Check Function - file corruptions check, queue image for processing
enqueueImage:
  handler: src/handlers/enqueueImage.handler
  events:
    - s3:
        bucket: ${self:custom.bucketName}
        event: s3:ObjectCreated:*
        existing: true
  environment:
    BUCKET_NAME: ${self:custom.bucketName}
    SNS_TOPIC_ARN: 
      Ref: ImageProcessingTopic
  role: EnqueueImageFunctionRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

# Worker Function - main processing functions
worker:
  handler: src/handlers/worker.handler
  memorySize: 2048
  timeout: 300 #5 minutes (5 * 60 = 300 seconds)
  events:
    - sqs:
        arn:
          Fn::GetAtt: [EligibleImageQueue, Arn]
        batchSize: 10
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    IMAGE_HASH_TABLE: ${self:provider.environment.IMAGE_HASH_TABLE}
    DEAD_LETTER_QUEUE_URL:
      Ref: ImageDeadLetterQueue
  role: WorkerFunctionRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:testSharp:1
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

# Dead Letter Queue Processor
deadLetterQueueProcessor:
  handler: src/handlers/deadLetterQueueProcessor.handler
  events:
    - sqs:
        arn:
          Fn::GetAtt: [ImageDeadLetterQueue, Arn]
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    DEAD_LETTER_QUEUE_URL:
      Ref: ImageDeadLetterQueue
    ORIGINAL_QUEUE_URL:
      Ref: EligibleImageQueue
  role: DeadLetterQueueProcessorRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

jobProgressChecker:
  handler: src/handlers/jobProgressChecker.handler
  memorySize: 2048
  timeout: 900 #15 minutes (15 * 60 = 900 seconds)
  events:
    - eventBridge:
        pattern:
          source:
            - "com.yourapp.jobcreation"
          detail-type:
            - "JobCreated"
            - "JobUpdated"
  environment:
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    JOB_PROGRESS_TABLE: ${self:provider.environment.JOB_PROGRESS_TABLE}
    JOB_COMPLETION_TOPIC_ARN: 
      Ref: JobCompletionTopic
  role: JobProgressCheckerRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

deliveryProcessor:
  name: ${self:provider.environment.DELIVERY_LAMBDA_PROCESSOR_NAME}
  handler: src/handlers/deliveryProcessor.handler
  memorySize: 2048
  timeout: 900 #15 minutes (15 * 60 = 900 seconds)
  events:
    - sqs:
        arn:
          Fn::GetAtt: [DeliveryQueue, Arn]
  environment:
    DELIVERY_LAMBDA_PROCESSOR_NAME: ${self:provider.environment.DELIVERY_LAMBDA_PROCESSOR_NAME}
    IMAGE_BUCKET: ${self:custom.bucketName}
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID}
    GOOGLE_CLIENT_SECRET: ${env:GOOGLE_CLIENT_SECRET}
    DELIVERY_QUEUE_URL:
      Ref: DeliveryQueue
    TASKS_TABLE: ${self:provider.environment.TASKS_TABLE}
    JOB_PROGRESS_TABLE: ${self:provider.environment.JOB_PROGRESS_TABLE}
    BUCKET_NAME: ${self:custom.bucketName}
  role: DeliveryProcessorRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1
    - arn:aws:lambda:us-east-1:980352750282:layer:jszip-layer:2
    - arn:aws:lambda:us-east-1:980352750282:layer:google-api-layer:1

notificationProcessor:
  handler: src/handlers/notificationProcessor.handler
  events:
    - sqs:
        arn:
          Fn::GetAtt: [NotificationQueue, Arn]
  environment:
    NOTIFICATION_QUEUE_URL:
      Ref: NotificationQueue
    SENDER_EMAIL_ADDRESS: ${env:SENDER_EMAIL_ADDRESS}
    JOB_PROGRESS_TABLE: ${self:provider.environment.JOB_PROGRESS_TABLE}
  role: NotificationProcessorRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1

# From External Drive
imageUploadProcessor:
  handler: src/handlers/imageUploader.handler
  memorySize: 2048
  events:
    - sqs:
        arn:
          Fn::GetAtt: [ImageUploadQueue, Arn]
        batchSize: 10
  environment:
    IMAGE_BUCKET: ${self:custom.bucketName}
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID}
    GOOGLE_CLIENT_SECRET: ${env:GOOGLE_CLIENT_SECRET}
  role: ImageUploaderFunctionRole
  layers:
    - arn:aws:lambda:us-east-1:980352750282:layer:supabaseLayer2:1
    - arn:aws:lambda:us-east-1:980352750282:layer:google-api-layer:1
